{% extends "habilidades/base.html" %}
{% load static %}
{% load project_tags %} <!-- Necessário para o filtro split_string -->

{% block title %}Detalhes do Projeto: {{ projeto.titulo|default:"Carregando..." }}{% endblock %}

{% block content %}
<div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
<div class="layout-content-container flex flex-col flex-1">

{% if not projeto %}
    {% if messages %}
        <div class="w-full mb-4 px-4">
        {% for message in messages %}
            <div class="p-4 bg-red-100 text-red-800 border border-red-200 rounded-lg">{{ message }}</div>
        {% endfor %}
        </div>
    {% else %}
        <p class="text-xl text-center py-10">Projeto não encontrado ou falha ao carregar. Verifique se o ID está correto.</p>
    {% endif %}
{% else %}

{% if messages %}
    <div class="w-full mb-4 px-4">
    {% for message in messages %}
        <div class="p-4 {% if message.tags == 'error' or message.tags == 'warning' %}bg-red-100 text-red-800 border border-red-200{% else %}bg-green-100 text-green-800 border border-green-200{% endif %} rounded-lg">{{ message }}</div>
    {% endfor %}
    </div>
{% endif %}

<div class="flex flex-wrap gap-2 pb-6">
<a class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal hover:underline" href="{% url 'habilidades:index' %}">Home</a>
<span class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">/</span>
<a class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal hover:underline" href="{% url 'habilidades:lista_projetos' %}">Projetos</a>
<span class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">/</span>
<span class="text-gray-900 dark:text-white text-sm font-medium leading-normal">{{ projeto.titulo }}</span>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="lg:col-span-2 flex flex-col gap-8">
<div class="flex flex-col gap-2">
<p class="text-4xl lg:text-5xl font-black leading-tight tracking-[-0.033em]">{{ projeto.titulo }}</p>
<p class="text-gray-500 dark:text-gray-400">
    Criado por 
    {% if owner %}
        <a class="font-medium underline text-primary" href="{% url 'habilidades:perfil_usuario' usuario_id=owner.id %}">{{ owner.username }}</a>
    {% else %}
        (ID {{ projeto.owner_id }})
    {% endif %}
</p>
</div>
<div>
<h2 class="text-2xl font-bold leading-tight tracking-[-0.015em] mb-3 text-gray-900 dark:text-white">Descrição/Propósito</h2>
<p class="text-base font-normal leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
    {{ projeto.proposito }}
</p>
</div>
<div>
<h2 class="text-2xl font-bold leading-tight tracking-[-0.015em] pb-4 text-gray-900 dark:text-white">Habilidades Necessárias</h2>
<div class="flex flex-wrap gap-3">
    {% if projeto.habilidades_requeridas %}
        <!-- CORREÇÃO DA VISUALIZAÇÃO: Usa o filtro split_string -->
        {% for habilidade in projeto.habilidades_requeridas|split_string:", " %}
            <span class="flex items-center justify-center rounded-lg px-3 py-1.5 bg-primary/20 text-gray-900 dark:text-white text-sm font-medium border border-primary/50">{{ habilidade }}</span>
        {% endfor %}
    {% else %}
        <p class="text-gray-500 dark:text-gray-400">Nenhuma habilidade requerida listada.</p>
    {% endif %}
</div>
</div>
{% if owner %}
<div>
<h2 class="text-2xl font-bold leading-tight tracking-[-0.015em] pb-4 text-gray-900 dark:text-white">Contatos do Criador ({{ owner.username }})</h2>
<div class="flex flex-wrap gap-3">
    <a href="mailto:{{ owner.email }}" class="flex items-center justify-center rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-sm font-bold text-gray-800 dark:text-gray-200 hover:bg-gray-200 transition-colors">
        <span class="material-symbols-outlined mr-2">mail</span>
        Email
    </a>
    <a href="{% url 'habilidades:perfil_usuario' usuario_id=owner.id %}" class="flex items-center justify-center rounded-lg h-10 px-4 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-sm font-bold text-gray-800 dark:text-gray-200 hover:bg-gray-200 transition-colors">
        <span class="material-symbols-outlined mr-2">person</span>
        Ver Perfil
    </a>
</div>
</div>
{% endif %}
</div>

<aside class="lg:col-span-1">
<div class="sticky top-24">
<div class="bg-white dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700/80 rounded-xl p-6 flex flex-col gap-6">
<div class="flex items-center gap-3">
    <div class="flex items-center gap-2 text-sm font-medium px-3 py-1 bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 rounded-full">
        <span class="size-2 rounded-full bg-green-500"></span>
        {{ projeto.status|default:"Indefinido" }}
    </div>
    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
        {{ colaboradores|length }} Colaborador{% if colaboradores|length != 1 %}es{% endif %}
    </p>
</div>

<div class="flex flex-col gap-4 text-sm">
    <div class="flex items-start gap-3">
        <span class="material-symbols-outlined mt-0.5 text-gray-500 dark:text-gray-400">location_on</span>
        <div>
            <p class="font-semibold text-gray-900 dark:text-white">Campus (Geolocalização)</p>
            <p class="text-gray-700 dark:text-gray-300">
                {{ projeto.campus|default:owner.campus|default:"Não informado" }}
            </p>
        </div>
    </div>
    <div class="flex items-start gap-3">
        <span class="material-symbols-outlined mt-0.5 text-gray-500 dark:text-gray-400">calendar_today</span>
        <div>
            <p class="font-semibold text-gray-900 dark:text-white">Criado em</p>
            <p class="text-gray-700 dark:text-gray-300">
                <!-- CORREÇÃO DA DATA: Aplica o filtro |date para formatar -->
                {{ projeto.created_at|default:"N/A"|date:"d/m/Y H:i" }}
            </p>
        </div>
    </div>
    <div class="flex items-start gap-3">
        <span class="material-symbols-outlined mt-0.5 text-gray-500 dark:text-gray-400">person</span>
        <div>
            <p class="font-semibold text-gray-900 dark:text-white">Owner ID</p>
            <p class="text-gray-700 dark:text-gray-300">{{ projeto.owner_id }}</p>
        </div>
    </div>
    <div class="flex items-start gap-3">
        <span class="material-symbols-outlined mt-0.5 text-gray-500 dark:text-gray-400">tag</span>
        <div>
            <p class="font-semibold text-gray-900 dark:text-white">ID do Projeto</p>
            <p class="text-gray-700 dark:text-gray-300">{{ projeto.id }}</p>
        </div>
    </div>
</div>

<!-- AÇÕES PRINCIPAIS CORRIGIDAS (Botão Avaliar e Botão Participar/Sair) -->
<div class="border-t border-gray-200 dark:border-gray-700 pt-4 flex flex-col gap-3">
    
    {% if is_owner %}
        <!-- AÇÕES PARA O OWNER -->
        <p class="font-semibold text-sm text-gray-500 dark:text-gray-400">Controles do Projeto:</p>
        <a href="{% url 'habilidades:editar_projeto' projeto_id=projeto.id %}" class="w-full flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-gray-900 text-sm font-bold transition-colors hover:opacity-90">
            <span class="material-symbols-outlined mr-2 !text-lg">edit</span>
            Editar Projeto
        </a>
        
        <form method="POST" action="{% url 'habilidades:gerenciar_projeto' projeto_id=projeto.id %}" onsubmit="return confirm('Tem certeza que deseja apagar este projeto? Esta ação é irreversível.');">
            {% csrf_token %}
            <input type="hidden" name="acao_gerenciamento" value="deletar">
            <button type="submit" class="w-full flex items-center justify-center rounded-lg h-10 px-4 bg-red-600 text-white text-sm font-bold transition-colors hover:bg-red-700">
                <span class="material-symbols-outlined mr-2 !text-lg">delete</span>
                Apagar Projeto
            </button>
        </form>
        
        <button disabled class="w-full flex min-w-[84px] items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-gray-400 text-gray-900 text-base font-bold leading-normal tracking-[0.015em] opacity-70 cursor-not-allowed">
            <span class="truncate">Você é o Criador</span>
        </button>

    {% else %}
        
        <!-- BOTÃO DE AVALIAÇÃO (DESTAQUE - Aparece para participantes) -->
        {% if participa_do_projeto and link_avaliar %}
            <a href="{{ link_avaliar }}" class="w-full flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-yellow-500 text-gray-900 text-base font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity mb-3">
                <span class="material-symbols-outlined mr-2 !text-lg">rate_review</span>
                Avaliar Projeto
            </a>
        {% endif %}

        <!-- AÇÕES DE PARTICIPAÇÃO -->
        {% if participa_do_projeto %}
            <form method="POST" action="{% url 'habilidades:participar_projeto' projeto_id=projeto.id %}">
                {% csrf_token %}
                <input type="hidden" name="acao" value="sair"> 
                <button type="submit" class="w-full flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-red-600 text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-red-700 transition-colors">
                    <span class="truncate">Sair do Projeto</span>
                </button>
            </form>
        {% else %}
            <form method="POST" action="{% url 'habilidades:participar_projeto' projeto_id=projeto.id %}">
                {% csrf_token %}
                <input type="hidden" name="acao" value="participar">
                <button type="submit" class="w-full flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-primary text-gray-900 text-base font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
                    <span class="truncate">Quero Participar</span>
                </button>
            </form>
        {% endif %}
    {% endif %}
</div>
</div>
</aside>
</div>

<div class="mt-12 lg:mt-16 border-t border-gray-200 dark:border-gray-700 pt-8">
<h2 class="text-2xl font-bold leading-tight tracking-[-0.015em] pb-6 text-gray-900 dark:text-white">Opiniões sobre o Projeto</h2>
<div class="flex flex-col gap-6">
    <!-- ATENÇÃO: ESTA SEÇÃO AINDA É MOCK. PRECISA DA INTEGRAÇÃO REAL DE AVALIAÇÕES -->
    {% for feedback in feedbacks %}
        <div class="bg-white dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700/80 rounded-xl p-5">
            <div class="flex items-center gap-3 mb-3">
                <div class="size-10 bg-center bg-no-repeat aspect-square bg-cover rounded-full" style='background-image: url("https://placehold.co/128x128/13ec5b/0d1b12?text=F");'></div>
                <div>
                    <p class="font-semibold text-gray-900 dark:text-white">{{ feedback.autor }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Agora</p>
                </div>
            </div>
            <p class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">{{ feedback.texto }}</p>
        </div>
    {% endfor %}

    <div class="mt-4">
        <h3 class="text-lg font-bold mb-3 text-gray-900 dark:text-white">Deixe sua opinião</h3>
        <div class="flex flex-col gap-4">
            <textarea class="form-textarea w-full min-h-24 resize-y rounded-lg text-gray-900 dark:text-gray-100 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 placeholder:text-gray-500 dark:placeholder:text-gray-400 text-base font-normal leading-normal" placeholder="Escreva seu comentário aqui..."></textarea>
            <button class="self-start flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-5 bg-primary text-gray-900 text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
                <span class="truncate">Enviar Comentário</span>
            </button>
        </div>
    </div>
</div>
</div>
{% endif %}
</div>
</div>
{% endblock %}